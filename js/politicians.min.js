(()=>{(function(){const i=document.getElementById("politician-search"),l=document.getElementById("politician-list"),d=document.getElementById("filter-level"),t=document.getElementById("filter-country"),u=document.getElementById("filter-xstatus"),s=document.getElementById("politician-stats");if(!l||!i||!u||!s){console.warn("Required elements not found (list/search/status/stats).");return}const A=window.PAGE_TITLE?window.PAGE_TITLE.replace(/^["“]|["”]$/g,""):"",h=!!d,m=!!t,r=window.POLITICIANS||[];let e=[];if(Array.isArray(r))e=r;else if(typeof r=="string")try{const t=JSON.parse(r);Array.isArray(t)&&(e=t)}catch(e){console.warn("Failed to parse POLITICIANS JSON string:",e)}const c=document.getElementById("email-tools");function v(e){return String(e||"").trim().toLowerCase()}function _(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}function k(e){const t=new Set;return e.forEach(e=>{const n=v(e.email);n&&_(n)&&t.add(n)}),Array.from(t)}function E(e,t){const n=[];for(let s=0;s<e.length;s+=t)n.push(e.slice(s,s+t));return n}async function w(e){if(navigator.clipboard&&window.isSecureContext){await navigator.clipboard.writeText(e);return}const t=document.createElement("textarea");t.value=e,t.style.position="fixed",t.style.left="-9999px",document.body.appendChild(t),t.focus(),t.select(),document.execCommand("copy"),document.body.removeChild(t)}function n(e){const t=(e.xStatus||"").toLowerCase();return t==="active"||t==="exited"||t==="none"||t==="unknown"?t:e.usesX===!0?"active":e.usesX===!1?"none":"unknown"}function b(e){const t=n(e);return t==="exited"?"x-exited":t==="active"?"x-active":t==="none"?"x-none":"x-unknown"}function j(e,t){if(!t)return!0;const s=n(e);return t==="active"||t==="exited"||t==="none"?s===t:t==="on"?s==="active":t!=="off"||s==="none"}function y(e){const t=n(e),i=e.xHandle?` (${e.xHandle})`:"";let s="Status unknown";t==="active"?s="Still active on X":t==="exited"?s="Has eXited":t==="none"&&(s="Not on X"),t==="exited"&&e.xLastArchiveUrl&&(s+=` - <a href="${e.xLastArchiveUrl}" class="link-primary" target="_blank" rel="noopener noreferrer">see exit post</a>`);const a=e.xHandle&&(t==="active"||t==="exited")?`<a href="https://x.com/${e.xHandle.replace("@","")}" class="link-primary" target="_blank" rel="noopener noreferrer">${e.xHandle}</a>`:"",o=a||i;return`
      <li>
        <strong>X status:</strong> ${s}
        ${o?` ${o}`:""}
      </li>
    `}const a=new Map;if(e.forEach(e=>{e.countryCode&&e.country?a.set(e.countryCode,e.country):e.country&&a.set(e.country,e.country)}),t){const e=Array.from(a.entries()).sort((e,t)=>e[1].localeCompare(t[1],0[0],{sensitivity:"base"}));e.forEach(([e,n])=>{const s=document.createElement("option");s.value=e,s.textContent=n,t.appendChild(s)})}function g(e,t){if(!s)return;const o=e.length;if(o===0){s.innerHTML='<p class="politician-stats-text">No politicians match the current filters.</p>';return}let r=0,c=0,l=0,d=0;e.forEach(e=>{const t=n(e);t==="active"?r+=1:t==="exited"?c+=1:t==="none"?l+=1:d+=1});const u=r,p=c+l,h=Math.round(u/o*100),m=f({searchTerm:i.value.trim(),countryValue:t});function f({searchTerm:e,countryValue:t}){if(e)return`Search results for “${e}”`;if(t){const e=a.get(t);return`${e||t} MEPs`}return window.PAGE_TITLE?A:"All countries"}s.innerHTML=`
      <div class="stats-card" role="region" aria-label="X account statistics">
        <div class="stats-title">${m} on X</div>

        <div class="stats-bar-info">
          <div class="stats-percentage">${h}%</div>
          <div class="stats-total">${u} of ${o} MPs are active on X</div>
        </div>

        <div class="stats-bar" aria-hidden="true">
          <div class="stats-bar-fill" style="width:${h}%"></div>
        </div>

        <div class="stats-boxes">
          <div class="stats-box active">
            <div class="stats-box-number">${r}</div>
            <div class="stats-box-label">Active on X</div>
          </div>

          <div class="stats-box exited">
            <div class="stats-box-number">${c}</div>
            <div class="stats-box-label">eXited</div>
          </div>

          <div class="stats-box not-on">
            <div class="stats-box-number">${l}</div>
            <div class="stats-box-label">Not on X</div>
          </div>

          ${d?`
            <div class="stats-box unknown">
              <div class="stats-box-number">${d}</div>
              <div class="stats-box-label">Unknown</div>
            </div>
          `:""}
        </div>
      </div>
    `}function O(e,t){if(!t)return!0;const n=t.toLowerCase(),s=[e.name,e.country,e.level,e.institution,e.role,e.party,e.xHandle,e.email];return s.filter(Boolean).some(e=>String(e).toLowerCase().includes(n))}function x(e,t){return!t||(e.level||"").toLowerCase()===t.toLowerCase()}function C(e,t){if(!t)return!0;const n=(e.countryCode||e.country||"").toString().toLowerCase();return n===t.toLowerCase()}function p(e){if(!e.length){l.innerHTML="<p>No politicians match your filters.</p>";return}const t=e.map(e=>{const t=e.country||e.countryCode||"",n=e.level==="eu"?"EU level":e.level==="national"?"National":e.level||"",s=b(e);return`
          <article class="politician-card ${s}">
            <h2>${e.name}</h2>
            <ul>
              ${t?`<li><strong>Country:</strong> ${t}</li>`:""}
              ${n?`<li><strong>Level:</strong> ${n}</li>`:""}
              ${e.institution?`<li><strong>Institution:</strong> ${e.institution}</li>`:""}
              ${e.role?`<li><strong>Role:</strong> ${e.role}</li>`:""}
              ${e.party?`<li><strong>Party:</strong> ${e.party}</li>`:""}
              ${e.email?`<li><strong>Email:</strong> <a href="mailto:${e.email}" class="link-primary">${e.email}</a></li>`:""}
              ${y(e)}
            </ul>
          </article>
        `}).join("");l.innerHTML=t}function f(e){if(!c)return;const n=k(e),s=n.length;if(s===0){c.innerHTML="";return}const o=120,t=E(n,o),i=t.map((e,n)=>{const s=n+1,o=`Copy email addresses (${s}/${t.length})`;return`<button type="button" class="email-btn" data-part="${n}">${o}</button>`}).join("");c.innerHTML=`
      <div class="email-tools-card">
        <div class="email-tools-summary">
          <strong>${s}</strong> unique email addresses found.
          <span class="email-tools-hint">Copy in parts for mail clients.</span>
        </div>

        <div class="email-tools-buttons">
          ${i}
        </div>

        <div class="email-tools-note">
          Tip: paste addresses into <strong>BCC</strong> to avoid exposing recipients.
        </div>
      </div>
    `,c.querySelectorAll("button[data-part]").forEach(e=>{e.addEventListener("click",async()=>{const n=Number(e.getAttribute("data-part")),s=t[n],o=s.join("; ");try{await w(o);const t=e.textContent;e.textContent="Copied!",setTimeout(()=>e.textContent=t,1200)}catch(e){console.warn("Copy failed:",e),alert("Copy failed. Try a different browser or copy manually.")}})})}function o(){const o=i.value.trim(),a=h?d.value:"",s=m?t.value:"",r=u.value,n=e.filter(e=>O(e,o)&&x(e,a)&&C(e,s)&&j(e,r));p(n),g(n,s),f(n)}p(e),g(e,""),f(e),i.addEventListener("input",o),u.addEventListener("change",o),h&&d.addEventListener("change",o),m&&t.addEventListener("change",o)})()})()